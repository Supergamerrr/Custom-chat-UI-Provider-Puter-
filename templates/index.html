<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deepseek Chat</title>
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --background: #0a0a0a;
            --surface: #1a1a1a;
            --border: #2a2a2a;
            --text-primary: #f8fafc;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            height: 100vh;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        h1 {
            font-size: 2rem;
            margin: 0;
            background: linear-gradient(45deg, #6366f1 0%, #a855f7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .chat-box {
            flex: 1;
            background: var(--surface);
            border-radius: 1rem;
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            overflow-y: auto;
            border: 1px solid var(--border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
        }

        .message {
            max-width: 80%;
            padding: 1rem 1.25rem;
            border-radius: 1rem;
            animation: messageAppear 0.3s ease-out;
        }
        .heading {
            font-size: 1.2em;
            font-weight: bold;
            margin: 10px 0;
            color: #4CAF50;
        }
        @keyframes messageAppear {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            background: var(--primary);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
            margin: 0.8rem 0;
            line-height: 1.7;
        }
        .md-heading {
            color: #4CAF50;
            font-size: 1.2em;
            margin: 1.5rem 0 1rem;
            border-bottom: 1px solid #4CAF5033;
            padding-bottom: 0.5rem;
        }

        .inline-code {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Fira Code', monospace;
            color: #7ec699;
            font-size: 0.9em;
        }

        .md-list {
            padding-left: 1.5rem;
            margin: 1rem 0;
            list-style-type: disc;
        }

        .md-list-item {
            margin: 0.5rem 0;
            line-height: 1.6;
        }

        .md-link {
            color: #64B5F6;
            text-decoration: underline;
            transition: opacity 0.2s;
        }

        .md-link:hover {
            opacity: 0.8;
        }

        .ai-message p {
            margin: 0.8rem 0;
            line-height: 1.7;
        }
        .input-container {
            display: flex;
            gap: 0.75rem;
            position: relative;
        }

        #message-input {
            flex: 1;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            background: var(--surface);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        #message-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.25);
        }

        #send-button {
            padding: 0.75rem 1.5rem;
            background: var(--primary);
            border: none;
            border-radius: 0.75rem;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        #send-button:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        #model-select {
            padding: 0.75rem;
            border-radius: 0.75rem;
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-size: 1rem;
        }


        .code-container {
            position: relative;
            margin: 1em 0;
            border-radius: 8px;
            overflow: hidden;
        }

        pre[class*="language-"] {
            margin: 0;
            padding: 1.5em !important;
            background: #1e1e1e !important;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            background: rgba(40, 40, 40, 0.9);
            backdrop-filter: blur(4px);
            border-bottom: 1px solid #ffffff1a;
        }

        .code-lang {
            color: #ce9178;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            order: 1; /* –ü–µ—Ä–µ–º–µ—â–∞–µ–º —è–∑—ã–∫ –≤–ª–µ–≤–æ */
        }

        .copy-button {
            order: 2; /* –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–ø—Ä–∞–≤–æ */
            margin-left: auto; /* –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø —Å–ª–µ–≤–∞ –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è –≤–ø—Ä–∞–≤–æ */
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            padding: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }

        .copy-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .copy-button.copied {
            background: #4CAF50;
            border-color: #45a049;
        }

        .copy-button.copy-error {
            background: #f44336;
            border-color: #d32f2f;
        }

        .copy-icon, .check-icon {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        .copy-icon {
            color: #9cdcfe;
        }

        .check-icon {
            color: white;
        }

        .code-header {
            padding: 6px 10px;
            background: #2d2d2d99;
            backdrop-filter: blur(4px);
            border-bottom: 1px solid #ffffff1a;
        }

        .code-lang {
            color: #ce9178;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .code-block {
            margin: 0;
            padding: 15px;
            overflow-x: auto;
            border-radius: 0 0 6px 6px;
        }
        .token.comment,
        .token.prolog,
        .token.doctype,
        .token.cdata {
            color: #6A9955;
        }

        .token.keyword {
            color: #569CD6;
        }

        .token.string {
            color: #CE9178;
        }

        .token.function {
            color: #DCDCAA;
        }

        a {
            color: #2196F3;
            text-decoration: none;
        }
        .code-block::before {
            content: 'üñ•Ô∏è';
            position: absolute;
            right: 1rem;
            top: 0.5rem;
            opacity: 0.3;
        }

        .loading-message {
            padding: 1rem;
            background: var(--surface);
            border-radius: 0.75rem;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            width: fit-content;
        }

        .loading-dots {
            display: flex;
            gap: 0.25rem;
        }
        .loading-message {
            transition: opacity 0.3s ease;
        }

        .loading-message-remove {
            opacity: 0;
        }
        .loading-dots div {
            width: 6px;
            height: 6px;
            background: var(--primary);
            border-radius: 50%;
            animation: bounce 1.4s infinite;
        }

        .loading-dots div:nth-child(2) { animation-delay: 0.2s; }
        .loading-dots div:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-6px); }
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--surface);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }
    </style>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism-okaidia.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-sql.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Deepseek AI</h1>
        <select id="model-select">
            <option value="deepseek-chat">Deepseek Reasoner</option>
            <option value="deepseek-coder">Deepseek Chat (–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω)</option>
        </select>
        
        <div class="chat-box" id="chat-box">
            <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
        </div>

        <div class="input-container">
            <input type="text" id="message-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
            <button id="send-button">
                <span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</span>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                </svg>
            </button>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script>
        const chatBox = document.getElementById('chat-box');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const modelSelect = document.getElementById('model-select');
        let isLoading = false;
        let loadingElement = null;

        let loadingMessage = null;
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è DOMPurify

        const sanitizeConfig = {
            ALLOWED_TAGS: ['div', 'pre', 'code', 'span', 'button', 'svg', 'path', 'strong', 'em', 'a'],
            ALLOWED_ATTR: ['class', 'onclick', 'href', 'target', 'viewbox', 'd', 'fill'],
            FORBID_TAGS: ['script', 'style', 'iframe'],
            ALLOW_DATA_ATTR: false,
            ADD_ATTR: ['class']
        };
        function escapeHtml(text) {
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }
        const formatMessage = (message) => {
            // –®–∞–≥ 1: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞ —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞–º–∏
            const codeBlocks = [];
            const placeholderPrefix = 'üÑ≤üÑ±üÑªüÑæüÑ≤üÑ∫'; // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø—Ä–µ—Ñ–∏–∫—Å
            let processedMessage = message.replace(/```([\s\S]*?)```/g, (match, code) => {
                const blockId = codeBlocks.length;
                code = code.replace(/^(\w+)\n/, (_, lang) => {
                    return `LANG:${lang}\n`;
                });
                
                codeBlocks.push({
                    html: `<div class="code-container">${generateCodeBlockHtml(code)}</div>`,
                    raw: code
                });
                
                return `${placeholderPrefix}${blockId}${placeholderPrefix}`;
            });

            // –®–∞–≥ 2: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ Markdown
            processedMessage = processedMessage
                .replace(/###\s+(.+)/g, '<h3 class="heading">$1</h3>')
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g, '<em>$1</em>')
                .replace(/`(.+?)`/g, '<code class="inline-code">$1</code>')
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
                .replace(/\n\s*-\s+/g, '\n<li>')
                .replace(/(<li>.*<\/li>)/g, '<ul>$1</ul>');

            // –®–∞–≥ 3: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞
            processedMessage = processedMessage.replace(
                new RegExp(`${placeholderPrefix}(\\d+)${placeholderPrefix}`, 'g'),
                (_, id) => codeBlocks[id]?.html || ''
            );

            // –®–∞–≥ 4: –§–∏–Ω–∞–ª—å–Ω–∞—è —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è
            return DOMPurify.sanitize(processedMessage, {
                ALLOWED_TAGS: ['h3', 'strong', 'em', 'code', 'a', 'ul', 'li', 'div', 'pre', 'button', 'svg', 'path', 'span'],
                ALLOWED_ATTR: ['class', 'href', 'target', 'onclick', 'viewBox', 'd', 'fill'],
                FORBID_TAGS: ['script', 'style']
            });
        };
        function generateCodeBlockHtml(code) {
            const langMatch = code.match(/^LANG:(\w+)\n/);
            const lang = langMatch ? langMatch[1] : 'plaintext';
            const codeContent = langMatch ? code.replace(/^LANG:\w+\n/, '') : code;
            
            return `
                <div class="code-header">
                    <span class="code-lang">${escapeHtml(lang)}</span>
                    <button class="copy-button" onclick="copyCode(this)">
                        <svg class="copy-icon" viewBox="0 0 24 24">
                            <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                        </svg>
                    </button>
                </div>
                <pre class="code-block"><code class="language-${escapeHtml(lang)}">${escapeHtml(codeContent)}</code></pre>
            `;
        }

        function addMessage(message, isUser) {
            setTimeout(() => {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', isUser ? 'user-message' : 'ai-message');
                messageDiv.innerHTML = formatMessage(message);
                chatBox.appendChild(messageDiv);
                chatBox.scrollTop = chatBox.scrollHeight;
                Prism.highlightAllUnder(chatBox);
            }, 300);
        }
        function copyCode(button) {
            try {
                const codeBlock = button.closest('.code-container').querySelector('.code-block');
                const text = codeBlock.textContent;
                
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(text).then(() => {
                        showCopyFeedback(button);
                    }).catch(() => {
                        fallbackCopy(text, button);
                    });
                } else {
                    fallbackCopy(text, button);
                }
            } catch (error) {
                console.error('Copy failed:', error);
                button.classList.add('copy-error');
                setTimeout(() => button.classList.remove('copy-error'), 2000);
            }
        }
        function fallbackCopy(text, button) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showCopyFeedback(button);
        }
        function showCopyFeedback(button) {
            button.innerHTML = '<svg class="check-icon" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>';
            button.classList.add('copied');
            setTimeout(() => {
                button.innerHTML = '<svg class="copy-icon" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>';
                button.classList.remove('copied');
            }, 2000);
        }
        function showLoading() {
            if (isLoading) return;
            
            isLoading = true;
            setTimeout(() => {
                loadingElement = document.createElement('div');
                loadingElement.className = 'message ai-message loading-message';
                loadingElement.innerHTML = `
                    <div class="loading-dots">
                        <div></div>
                        <div></div>
                        <div></div>
                    </div>
                    <span>–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç...</span>
                `;
                chatBox.appendChild(loadingElement);
                chatBox.scrollTop = chatBox.scrollHeight;
            }, 600);
        }
        // –û—Å—Ç–∞–ª—å–Ω–æ–π JavaScript –æ—Å—Ç–∞–µ—Ç—Å—è –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–º —Å –Ω–µ–±–æ–ª—å—à–∏–º–∏ –∞–¥–∞–ø—Ç–∞—Ü–∏—è–º–∏
        
        function hideLoading() {
            if (loadingElement && isLoading) {
                loadingElement.classList.add('loading-message-remove');
                setTimeout(() => {
                    loadingElement.remove();
                    isLoading = false;
                    loadingElement = null;
                }, 300);
            }
        }


        function sendMessage() {
            const message = messageInput.value.trim();
            const selectedModel = modelSelect.value;
            if (!message) return;

            addMessage(message, true);
            messageInput.value = '';

            showLoading();

            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message: message, model: selectedModel })
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.error) {
                    addMessage('–û—à–∏–±–∫–∞: ' + data.error, false);
                } else {
                    addMessage(data.response, false);
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Error:', error);
                addMessage('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è.', false);
            });
        }

        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>

    